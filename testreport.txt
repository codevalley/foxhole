============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-7.4.0, pluggy-1.5.0 -- c:\Users\narayan\Develop\foxhole\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\narayan\Develop\foxhole
configfile: pytest.ini
plugins: anyio-3.7.1, asyncio-0.21.1
asyncio: mode=Mode.AUTO
collecting ... collected 36 items

tests/test_auth.py::test_register_user PASSED                            [  2%]
tests/test_auth.py::test_login PASSED                                    [  5%]
tests/test_auth.py::test_get_current_user PASSED                         [  8%]
tests/test_auth.py::test_update_user_profile PASSED                      [ 11%]
tests/test_auth.py::test_invalid_token PASSED                            [ 13%]
tests/test_auth.py::test_missing_token PASSED                            [ 16%]
tests/test_auth.py::test_create_access_token PASSED                      [ 19%]
tests/test_auth.py::test_login_for_access_token_invalid_user PASSED      [ 22%]
tests/test_auth.py::test_get_current_user_invalid_token PASSED           [ 25%]
tests/test_auth.py::test_update_user_profile_no_changes PASSED           [ 27%]
tests/test_dependencies.py::test_minio_storage_service_upload_file_error PASSED [ 30%]
tests/test_dependencies.py::test_minio_storage_service_get_file_url_error PASSED [ 33%]
tests/test_dependencies.py::test_minio_storage_service_list_files_error PASSED [ 36%]
tests/test_dependencies.py::test_get_storage_service_mock PASSED         [ 38%]
tests/test_dependencies.py::test_get_storage_service_minio PASSED        [ 41%]
tests/test_files.py::test_upload_file PASSED                             [ 44%]
tests/test_files.py::test_list_files PASSED                              [ 47%]
tests/test_files.py::test_get_file_url PASSED                            [ 50%]
tests/test_files.py::test_get_file_url_not_found PASSED                  [ 52%]
tests/test_health.py::test_health_check PASSED                           [ 55%]
tests/test_main.py::test_register_user PASSED                            [ 58%]
tests/test_main.py::test_login PASSED                                    [ 61%]
tests/test_main.py::test_get_user_profile PASSED                         [ 63%]
tests/test_main.py::test_update_user_profile PASSED                      [ 66%]
tests/test_main.py::test_health_check PASSED                             [ 69%]
tests/test_main.py::test_invalid_login PASSED                            [ 72%]
tests/test_main.py::test_update_nonexistent_user PASSED                  [ 75%]
tests/test_websocket.py::test_websocket_connection PASSED                [ 77%]
tests/test_websocket.py::test_websocket_disconnect PASSED                [ 80%]
tests/test_websocket.py::test_websocket_personal_message PASSED          [ 83%]
tests/test_websocket.py::test_websocket_multiple_messages PASSED         [ 86%]
tests/test_websocket.py::test_websocket_invalid_token PASSED             [ 88%]
tests/test_websocket.py::test_websocket_uninitialized_manager PASSED     [ 91%]
tests/test_websocket.py::test_websocket_sqlalchemy_error FAILED          [ 94%]
tests/test_websocket.py::test_websocket_invalid_json PASSED              [ 97%]
tests/test_websocket.py::test_websocket_unauthorized PASSED              [100%]

================================== FAILURES ===================================
_______________________ test_websocket_sqlalchemy_error _______________________

client = <starlette.testclient.TestClient object at 0x0000027F95648680>
token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4MmZjNmE1Ni0wYjgwLTRkMzktYjE0Ny01ODc2OGIwZWEyNDEiLCJleHAiOiIxNzI2MDUxMjc3In0.1XFAPOPFczQn2onP_wpqqhDT4rS8pkxQcBatAX-gFgg'
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x0000027F955DE9C0>

    @pytest.mark.asyncio
    async def test_websocket_sqlalchemy_error(
        client: TestClient, token: str, monkeypatch: pytest.MonkeyPatch
    ) -> None:
        def mock_get_current_user_ws(*args, **kwargs):
            raise SQLAlchemyError("Database error")

        monkeypatch.setattr("app.dependencies.get_current_user_ws", mock_get_current_user_ws)

>       with pytest.raises(WebSocketDisconnect) as excinfo:
E       Failed: DID NOT RAISE <class 'starlette.websockets.WebSocketDisconnect'>

tests\test_websocket.py:119: Failed
---------------------------- Captured stdout setup ----------------------------
2024-09-11 15:41:17,438 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2024-09-11 15:41:17,438 INFO sqlalchemy.engine.Engine INSERT INTO users (id, screen_name, user_secret) VALUES (?, ?, ?)
2024-09-11 15:41:17,438 INFO sqlalchemy.engine.Engine [cached since 0.2996s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241', 'testuser', None)
2024-09-11 15:41:17,441 INFO sqlalchemy.engine.Engine COMMIT
2024-09-11 15:41:17,454 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2024-09-11 15:41:17,454 INFO sqlalchemy.engine.Engine SELECT users.id, users.screen_name, users.user_secret
FROM users
WHERE users.id = ?
2024-09-11 15:41:17,454 INFO sqlalchemy.engine.Engine [cached since 1.883s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241',)
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2685 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1844 INSERT INTO users (id, screen_name, user_secret) VALUES (?, ?, ?)
INFO     sqlalchemy.engine.Engine:base.py:1844 [cached since 0.2996s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241', 'testuser', None)
INFO     sqlalchemy.engine.Engine:base.py:2691 COMMIT
INFO     sqlalchemy.engine.Engine:base.py:2685 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1844 SELECT users.id, users.screen_name, users.user_secret
FROM users
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1844 [cached since 1.883s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241',)
---------------------------- Captured stdout call -----------------------------
2024-09-11 15:41:17,458 INFO sqlalchemy.engine.Engine SELECT users.id, users.screen_name, users.user_secret
FROM users
WHERE users.id = ?
2024-09-11 15:41:17,459 INFO sqlalchemy.engine.Engine [cached since 1.793s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241',)
------------------------------ Captured log call ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:1844 SELECT users.id, users.screen_name, users.user_secret
FROM users
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1844 [cached since 1.793s ago] ('82fc6a56-0b80-4d39-b147-58768b0ea241',)
-------------------------- Captured stdout teardown ---------------------------
2024-09-11 15:41:17,800 INFO sqlalchemy.engine.Engine ROLLBACK
---------------------------- Captured log teardown ----------------------------
INFO     sqlalchemy.engine.Engine:base.py:2688 ROLLBACK
============================== warnings summary ===============================
.venv\Lib\site-packages\pydantic\_internal\_config.py:267
.venv\Lib\site-packages\pydantic\_internal\_config.py:267
.venv\Lib\site-packages\pydantic\_internal\_config.py:267
.venv\Lib\site-packages\pydantic\_internal\_config.py:267
  c:\Users\narayan\Develop\foxhole\.venv\Lib\site-packages\pydantic\_internal\_config.py:267: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.4/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/test_auth.py: 3 warnings
tests/test_files.py: 2 warnings
tests/test_main.py: 2 warnings
tests/test_websocket.py: 6 warnings
  c:\Users\narayan\Develop\foxhole\.venv\Lib\site-packages\jose\jwt.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = timegm(datetime.utcnow().utctimetuple())

tests/test_auth.py::test_create_access_token
  tests\test_auth.py:106: PytestWarning: The test <Function test_create_access_token> is marked with '@pytest.mark.asyncio' but it is not an async function. Please remove asyncio marker. If the test is not marked explicitly, check for global markers applied via 'pytestmark'.
    def test_create_access_token() -> None:

tests/test_websocket.py::test_websocket_connection
tests/test_websocket.py::test_websocket_disconnect
tests/test_websocket.py::test_websocket_multiple_messages
tests/test_websocket.py::test_websocket_multiple_messages
  C:\Users\narayan\Develop\foxhole\app\services\websocket_manager.py:61: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.4/migration/
    sender_info.dict()

tests/test_websocket.py::test_websocket_connection
tests/test_websocket.py::test_websocket_disconnect
tests/test_websocket.py::test_websocket_multiple_messages
tests/test_websocket.py::test_websocket_multiple_messages
  c:\Users\narayan\Develop\foxhole\.venv\Lib\site-packages\pydantic\main.py:962: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.4/migration/
    warnings.warn('The `dict` method is deprecated; use `model_dump` instead.', DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_websocket.py::test_websocket_sqlalchemy_error - Failed: DID...
================== 1 failed, 35 passed, 26 warnings in 2.53s ==================
